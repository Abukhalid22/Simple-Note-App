name: Build, Test, Analyze, and Deploy

on:
  push:
    branches:
      - master

jobs:
  build-test-analyze-deploy:
    runs-on: ubuntu-latest
    env:
      DJANGO_IMAGE_TAG: mctoosh94/mynotes:backend-${{ github.sha }}
      REACT_IMAGE_TAG: mctoosh94/mynotes:frontend-${{ github.sha }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Fetch latest changes
        run: git fetch --prune --unshallow

      - name: Install dependencies
        run: |
          npm install --prefix frontend
          pip install -r requirements.txt
          pip install coverage

      - name: Run tests with coverage
        run: coverage run manage.py test

      - name: Generate coverage report in XML format
        run: coverage xml -o coverage.xml

      - name: Run SonarCloud Analysis
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }} # PAT
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=abukhalid22
            -Dsonar.projectKey=Abukhalid22_Simple-Note-App
            -Dsonar.python.coverage.reportPaths=coverage.xml

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }} # Docker Token

      - name: Build and Push Django Image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.DJANGO_IMAGE_TAG }}

      - name: Build and Push React Image
        uses: docker/build-push-action@v2
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.REACT_IMAGE_TAG }}

      - name: Update Kubernetes Manifests with New Image Tags
        run: |
          sed -i "s|image: mctoosh94/mynotes:backend-.*|image: ${{ env.DJANGO_IMAGE_TAG }}|" ./k8s/django-deployment.yaml
          sed -i "s|image: mctoosh94/mynotes:frontend-.*|image: ${{ env.REACT_IMAGE_TAG }}|" ./k8s/react-deployment.yaml
          
          # Check for changes and configure git
          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'
          
          # Check if there are any changes
          git diff --quiet || {
            echo "Changes detected, updating Kubernetes manifests."
            
            # Add modified files to the staging area
            git add ./k8s/*.yaml
            
            # Commit and push the changes
            git commit -m "Update Kubernetes manifests to new image tags: ${{ github.sha }}"
            git push https://${{ secrets.ARGOCD_NOTES_APP_PAT }}:x-oauth-basic@github.com/Abukhalid22/Simple-Note-App.git HEAD:master
          }
